#include "NXCDefs.h"
#include "utilities.nxc"

byte r [6400];
byte g [6400];
byte b [6400];
int x=0;
int y=0;
int i=0;
int a;
int c[10];
int rawdata[3];
byte temp=0;
int s=0;
int e=0;
byte points [3];
int filehandle;
byte con;

task main()
{
     SetSensorTouch(IN_1);
     SetSensorTouch(IN_2);
     SetSensorColorFull(IN_3);

     OnRev(OUT_B,40);
     until(Sensor(IN_1)==1);
     Off(OUT_B);
     RotateMotor(OUT_B,100,400);
     //until(Sensor(IN_2)==1);
     OnFwd(OUT_A,40);
     until(Sensor(IN_3)==6);
     Wait(100);
     until(Sensor(IN_3)==1);
     Wait(100);
     until(Sensor(IN_3)==6);
     Off(OUT_A);
     RotateMotor(OUT_B,100,-350);
     //RotateMotor(OUT_B,50,50);

     repeat(50)
     {
                repeat(64)
                {
                          RotateMotorEx(OUT_B,100,11,0,0,0);
                          if (Sensor(IN_3)==1)
                          {
                             PointOut(x,y,0);
                          }
                          y++;
                          ReadSensorColorEx(IN_3,a,c,c,rawdata);
                          r[i]=rawdata[0]*0,85;
                          g[i]=rawdata[1]*0,85;
                          b[i]=rawdata[2]*0,85;
                          i++;
                }
                Off(OUT_B);
                RotateMotor(OUT_A,60,7);
                x++;
                repeat(64)
                {
                          RotateMotorEx(OUT_B,100,-11,0,0,0);
                          if (Sensor(IN_3)==1)
                          {
                             PointOut(x,y,0);
                          }
                          y--;
                          ReadSensorColorEx(IN_3,a,c,c,rawdata);
                          r[i]=rawdata[0]*0,85;
                          g[i]=rawdata[1]*0,85;
                          b[i]=rawdata[2]*0,85;
                          i++;
                }
                Off(OUT_B);
     						RotateMotor(OUT_A,60,7);
                x++;
     }
     
     //filehandle=CreateBMP("image",100,64);
     byte fileheader[];
     byte infoheader[];

     ArrayInit(fileheader,0,14);
     ArrayInit(infoheader,0,40);

     DeleteFile("image.bmp");
     CreateFile("image.bmp",19254,filehandle);

     fileheader[0]=66;
     fileheader[1]=77;
     fileheader[2]=54;
     fileheader[3]=75;
     fileheader[4]=0;
		 fileheader[5]=0;
     fileheader[9]=54;
     WriteBytes(filehandle,fileheader,con);

     infoheader[0]=40;
     infoheader[4]=64;
     infoheader[8]=100;
     infoheader[12]=1;
     infoheader[14]=24;
     infoheader[19]=0;
     infoheader[23]=0;
     WriteBytes(filehandle,infoheader,con);

     i=0;
     repeat(50)
     {
               s=i;
               e=s+63;
               repeat(32)
               {
                         //ArraySwap(r,s,e);
                         //ArraySwap(g,s,e);
                         //ArraySwap(b,s,e);

                         temp=r[e];
                         r[e]=r[s];
                         r[s]=temp;
                         
                         temp=g[e];
                         g[e]=g[s];
                         g[s]=temp;
                         
                         temp=b[e];
                         b[e]=b[s];
                         b[s]=temp;
                         
                         s++;
                         e--;
                         //NumOut(10,10,temp,1);
                         //Wait(10);
               }
               i=128+i;
     }
     
     i=6399;
     repeat(6400)
     {
                 points[0]=b[i];
                 points[1]=g[i];
                 points[2]=r[i];
                 WriteBytes(filehandle,points,con);
                 i--;
     }
     
     CloseFile(filehandle);
}
